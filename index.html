<!doctype html>
<html lang="en">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta 
    name="viewport" 
    content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>NI House Price Map | Northern Ireland Property Values & Affordability Calculator</title>
  <meta 
    name="description" 
    content="Interactive map of Northern Ireland property values by postcode. Compare house prices, affordability, and area desirability. Includes postcode lookup and price calculator for houses and flats.">
  <meta name="keywords" content="Northern Ireland, house prices, property values, postcode map, affordability calculator, NI property, real estate, home prices, flats, houses, property map, price per square metre">
  <meta name="author" content="David Mulholland">
  <meta name="theme-color" content="linen">
  <meta property="og:title" content="NI House Price Map | Northern Ireland Property Values & Affordability Calculator">
  <meta property="og:description" content="Explore property values and affordability across Northern Ireland with an interactive postcode map and price calculator.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.nihousepricemap.com/">
  <meta property="og:image" content="https://www.nihousepricemap.com/static/dalle3_nihousepricemap_orangehousecartoon2.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="NI House Price Map | Northern Ireland Property Values & Affordability Calculator">
  <meta name="twitter:description" content="Explore property values and affordability across Northern Ireland with an interactive postcode map and price calculator.">
  <meta name="twitter:image" content="https://www.nihousepricemap.com/static/dalle3_nihousepricemap_orangehousecartoon2.png">
  <link rel="apple-touch-icon" href="/static/dalle3_nihousepricemap_orangehousecartoon2_48x48.ico">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin=""/>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://getbootstrap.com/docs/5.2/dist/css/bootstrap.min.css" media="screen">
  <link href="https://cdn.datatables.net/1.12.1/css/dataTables.bootstrap4.min.css" rel="stylesheet" type="text/css">

  <!-- Fonts -->
  <link rel="stylesheet" href='https://fonts.googleapis.com/css2?family=Gafata&display=swap' >
  <link rel="stylesheet" href="/static/fontawesome-free-5.15.1-web/css/all.min.css">

  <!--jquery UI autocomplete -->
  <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

  <!-- Leaflet marker cluster https://github.com/Leaflet/Leaflet.markercluster -->
  <link rel="stylesheet" src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
  <!-- Leaflet full screen https://github.com/brunob/leaflet.fullscreen -->
  <link rel="stylesheet" href="/static/leaflet.fullscreen-3.0.2/Control.FullScreen.css"/>

  <!-- Search bar https://github.com/stefanocudini/leaflet-search -->
  <link rel="stylesheet" href='/static/leaflet-search/leaflet-search.css'>

  <!-- My styling -->
  <link rel="stylesheet" href='/static/hp_style.css' type="text/css">

  <!-- Favicon for browser tab -->
  <link rel="shortcut icon" href="/static/dalle3_nihousepricemap_orangehousecartoon2_48x48.ico">

  <style>
    .legend { text-align: left; line-height: 10px; color: #555; padding: 6px 8px; background: white; box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; }
    .legend i { width: 10px; height: 10px; float: left; margin-right: 8px; opacity: 0.7; }
  </style>
</head>

<body>
  
  <!-- Sticky Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#" aria-label="NI House Price Map home">NI House Price Map</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav">
            <li class="nav-item">
            <a class="nav-link" href="#map" aria-label="Jump to map">Map</a>
            </li>
            <li class="nav-item">
            <a class="nav-link" href="#AffordabilityCalculator" aria-label="Jump to affordability calculator">Affordability calculator</a>
            </li>
            <li class="nav-item">
            <a class="nav-link" href="#PostcodesLookup" aria-label="Jump to postcode lookup">Postcodes</a>
            </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Jumbotron Banner -->
  <header>
    <div class="container">
      <div class="row my-4 justify-content-center">
        <div class="col-md-10">
          <div class="p-5 mb-4 bg-light rounded-3 shadow-sm">
            <div class="container-fluid py-2">
              <h1 class="display-5 fw-bold">The Property Value Map for Northern Ireland</h1>
              <p class="lead">The map shows the estimated <b>value added to a property, per square metre, by each postcode</b> in Northern Ireland.</p>
              <p>These are the differences in price that exist for properties of equal characteristics (type, size, garage, etc.), due to the relative desirability of different areas.</p>
              <p>
                Prices are estimates for today using most recent data from <b id="latest-data-date"></b>.
                Some postcodes are not present in the data due to an insufficient number of properties found in the Land &amp; Property Service (LPS) data (see <a href='#HowItWorks' aria-label="Jump to How it Works box"><b>How it works</b></a>).
              </p>
              <p>The map data can be viewed by individual postcode, or with postcodes grouped together by government Super Output Areas (SOAs)
                <span class='help-tooltip' title='A NISRA geography that divides Northern Ireland into 890 areas of approximately equal population' data-bs-toggle="tooltip"><i class="fas fa-question-circle fa-sm"></i></span>.
                Data can be filtered to show only houses or only flats/apartments, and searched by postcode.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  
  <main>
    <div class='container'>

      <div id="loading" style="text-align: center;">
        <img src="static/dalle3_nihousepricemap_orangehousecartoon2.png" alt="Loading..." />
        <p>Loading the map, one moment...</p>
      </div>

      <div class='row pb-2 justify-content-center'>
        <div class='col-md-12'>
          <div id="map" class="map map-home" style="height: 700px; margin-top: 30px"></div>
        </div>
      </div>

      <div class='row pt-4 justify-content-center'>
        <div class='col-md-8'>

          <div style="text-align: center;">
            <button id='HowItWorks' type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#myModal" style='font-size: 1.3em;'>
              How it works
            </button>
          </div>
          
        </div>
      </div>

      <div class="modal fade" id="myModal">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">

            <div class="modal-header">
              <h4 class="modal-title">How it works</h4>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                        
              <h1>Data and modelling</h1>

              <p>Property data, including 2005 valuations, are from <a href='https://www.finance-ni.gov.uk/topics/property-valuation/domestic-valuation' target='_blank' aria-label="Go to Finance NI Domestic Property Valuations">Land & Property Services.</a> These values are updated to today using <a href='https://www.finance-ni.gov.uk/articles/northern-ireland-house-price-index' aria-label='Go to Finance NI House Price Index' target='_blank'>NISRA's Northern Ireland House Price Index</a>, using separate factors for houses and flats/apartments, but only at the granularity of local government district (LGD) level. Price levels and the overall structure of the map represent today's market. However, small-scale patterns are based on 2005 data and may have changed slightly since then, where some areas have become more or less desirable within a district.</p>
                        
              <p>Values for each postcode come from a <a href='https://github.com/viva-ronaldo/ni-house-prices/blob/main/3_process_LPS.py' aria-label="Link to the source code on Github">simple statistical model</a> of <b>price per square metre</b> dependent on property type, floor area, presence of garden or garage, and postcode, trained on the LPS data. A value is only calculated for postcodes with at least 10 properties in the LPS data, and a small spatial smoothing is applied, to reduce noise and give more weight to postcodes with more data.</p>

              <p>These postcode coefficients are what is shown in the map: they capture <b>the value of the area itself</b>, independent of the particular kinds of properties (size, etc.) that are found in the area.</p>

              <p>Slightly simpler models, one each for houses and flats, are used for the Affordability Calculator. These models do not explicitly handle new builds, so a scaling of factor of 1.4 is applied to predicted prices in these cases. This captures quite well the premium that new build listings carry compared to resale properties; e.g., see <a href='https://news.twentyea.co.uk/blog/the-new-build-price-premium-how-much-more-will-we-pay-for-a-brand-new-property' aria-label='Visit supporting source' target='_blank'>here</a>. When a short postcode is used in the calculator, the 70th percentile of the predictions for that short postcode is used, because often new builds are part of a new long postcode that becomes more desirable than the average for that short postcode.</p>

              <p>The processing and modelling code is available <a href="https://github.com/viva-ronaldo/ni-house-prices/" aria-label="Link to the source code on Github">on GitHub</a>.</p>

              <h1>Validation</h1>
              
              <p>The primary purpose of the Price Map is to show the value of areas relative to each other, but for the Affordability Calculator to be useful, the price model must be accurately calibrated for recent asking prices. A sample of <b>sales listings</b> was obtained from <a href='https://www.propertynews.com/' aria-label="Visit Property News" target='_blank'>PropertyNews</a> in June 2024 and used to evaluate the calculator model's predictions. Floor area and presence of garden and garage were obtained by linking the properties to the LPS data, so these values may be outdated in some cases.</p>

              <img src='static/propertynews_validation_calculator_preds_plot_20240622.png' class='modal-plot' style='width: 90%'>

              <p>The plot above shows predicted prices for the sample of properties against their actual listed price. Predictions are evenly spread across the 1:1 line, indicating that predicted prices are well-calibrated (not consistently too high or too low). The mean absolute error for this sample is <b>£32,000</b>, and the mean absolute percentage error is <b>17%</b>, which indicates the accuracy of the calculator: for each calculator prediction, an actual property in the postcode could be considerably more or less expensive, depending on details particular to that property - number of bedrooms, quality of fittings, and so on - that are not considered by the calculator.</p>

              <p>The aim here is not to create the most accurate price model possible. The affordability calculator only indicates <i>the price of a typical property of a given size in each postcode</i>. The plot above does show, however, that the price model performs reasonably well at separating postcodes by property value, and is well calibrated for current prices.</p>
            </div>

          </div>
        </div>
      </div>

      <div class='row my-4 justify-content-center'>
        <div class='col-xl-6 col-lg-7 col-md-9 col-sm-10'>

          <div class="row no-gutters border rounded overflow-hidden flex-md-row mb-4 shadow-sm h-md-250 position-relative">
            <div class="col py-4 px-4 d-flex flex-column position-static afford_calc_box" id='AffordabilityCalculator'>
              <h2>Affordability calculator</h2>

              <p>Enter details of a hypothetical property and a postcode (either half or full), and the calculator returns the typical expected price for that property, based on the price per square metre model. This is only a rough indication, and cannot account for the unique features of a particular listed property, but can be used to estimate what combinations of location and property characteristics are affordable on your budget.</p>
              
              <form class='row mx-2 my-2 needs-validation' id='calc_form' onsubmit='return run_calculator()'>

                <div class='row mb-2'>
                  <div class='col-lg-4 col-sm-6'>
                    <p>I'm looking for a...</p>
                  </div>
                  <div class='col-lg-4 col-sm-6'>
                    <input type="radio" class="form-check-input" id="calc_hometype_h" name='calc_hometype' aria-describedby='calc_hometype_help' checked onchange="showGarageGarden()">
                    <label for="calc_hometype_h" class="form-label">House</label>
                    <input type="radio" class="form-check-input px-2" id="calc_hometype_f" name='calc_hometype' aria-describedby='calc_hometype_help' onchange="hideGarageGarden()">
                    <label for="calc_hometype_f" class="form-label">Flat</label>
                  </div>
                </div>

                <div class='row d-flex align-items-end'>
                  <div class="col-6">
                    <label for='calc_size' class='form-label mx-2'>...with floor size (including garage) <span class='help-tooltip' title="<ul><li>Total floor area should include garage and any outbuildings, but exclude garden</li><li>Compared to room-by-room area listings on property websites, it is generally best to err on the high side when estimating the total area</li><li>Specific property areas can be found on <a href='https://apps.spatialni.gov.uk/LPSDomesticValuation/index.html' target='_blank'>the LPS Domestic Property Valuation tool</a></li></ul>" data-bs-container='body' data-bs-toggle="tooltip" data-bs-html="true" data-bs-delay=800><i class="fas fa-question-circle fa-sm"></i></span>:</label>
                  </div>
                  <div class="col-6">
                    <label for="calc_postcode" class="form-label mx-2">...in postcode <span class='help-tooltip' title="Postcode format can be either  full ('BT1 3EW') or half ('BT1')" data-bs-toggle="tooltip" data-bs-html="true"><i class="fas fa-question-circle fa-sm"></i></span>:</label>
                  </div>
                </div>
                <div class='row mb-2'>
                  <div class="col-6">
                    <input type='number' min=10 max=500 class='form-control' aria-label='calc_size' id='calc_size' name='calc_size' placeholder='Area in m&sup2;' required>
                  </div>

                  <div class="col-6">
                    <input type="text" class="form-control" id="calc_postcode" name='calc_postcode' placeholder="e.g., 'BT78' or 'BT78 3QJ'"  required>
                    <div class="invalid-feedback">Please provide a valid postcode.</div>
                  </div>
                </div>

                <div class='row mb-2'>
                  <div class="col-6" id='garage_col'>
                    <label class="form-label" for="calc_garage_yn">...with garage?</label>
                    <select class="form-select" id="calc_garage_yn" name='calc_garage_yn' style='width: 100px'>
                      <option selected>Yes</option>
                      <option>No</option>
                    </select>
                  </div>
                  <div class="col-6" id='garden_col'>
                    <label class="form-label" for="calc_garden_yn">...with garden?</label>
                    <select class="form-select" id="calc_garden_yn" name='calc_garden_yn' style='width: 100px'>
                      <option selected>Yes</option>
                      <option>No</option>
                    </select>
                  </div>
                </div>

                <div class='row mb-2'>
                  <div class="col-9">
                    <label class="form-label" for="calc_garden_yn">...that is a new build?</label>
                    <select class="form-select" id="calc_newbuild_yn" name='calc_newbuild_yn' style='width: 100px'>
                      <option>Yes</option>
                      <option selected>No</option>
                    </select>
                  </div>
                </div>
                
                <div class='row my-3 justify-content-center'>
                  <div class='col-3'>
                    <button type="submit" class="btn btn-primary" style='font-size: 1.2em;'>Calculate</button>
                  </div>
                </div>
              </form>

              <div class='row'>
                <div class='col text-center'>
                  <p id='calc_output_1'></p>
                  <p id='calc_output_2'></p>
                </div>
              </div>

              <p id='calc_output_3'></p>

              <div>
                <canvas id="calculator_output_chart" style='display: none' height='200px'></canvas>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class='row my-4 justify-content-center'>
        <div class='col-md-10'>

          <div class="row no-gutters border rounded overflow-hidden flex-md-row mb-4 shadow-sm h-md-250 position-relative">
            <div class="col py-4 px-4 d-flex flex-column position-static postcode_table_box" id="PostcodesLookup">
              <h2>Postcode lookup</h2>

              <p>
                Use the <b>Search</b> box to filter by postcode or area (SOA). 
                Press <kbd>Enter</kbd> to apply your filter. 
                Click column headers to sort.
              </p>
              <p>Only postcodes with at least 10 domestic properties (house or flat) in the LPS data are shown.</p>
              
              <div class='row justify-content-center'>
                <div class='col-12 col-lg-10'>
                  <div class="table-responsive" style="border: 2px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); padding: 12px; background: #fff;">
                    <table id="postcodes-all-table" class="table table-striped table-bordered mb-0" style='width: 100%; font-size: 0.95em; border-radius: 6px; overflow: hidden;'>
                      <thead class="table-light">
                      <tr>
                      <th>Postcode</th>
                      <th>Average size</th>
                      <th>Average price</th>
                      <th>Price per sq. m compared to average</th>
                      </tr>
                      </thead>
                    </table>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>

    </div>

    <footer style="border-top: px solid #e5e5e5; background: #faf7f2;">
      <div class="container-fluid">
        <div class="row justify-content-center" style="font-size: 0.7em">
          <div class="col-12 text-center pt-2 pb-1">
            <p>
              © 2024-2025 David Mulholland
              <a href="https://github.com/viva-ronaldo/ni-house-prices" target="_blank" title="View source on GitHub" aria-label="View source on GitHub" style="margin-left: 10px;">
                <i class="fab fa-github github-hover" style="font-size: 1.2em; vertical-align: middle; color: #000;"></i>
              </a>
            </p>
          </div>
        </div>
      </div>
    </footer>
    
  </main>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>

  <!-- Load jQuery and PapaParse to read data from a CSV file -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  <!-- Popper.JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.4/js/dataTables.bootstrap4.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.3.0/js/dataTables.responsive.min.js"></script>

  <!--jquery UI autocomplete -->
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

  <!--Leaflet marker clusters-->
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <!-- Leaflet full screen https://github.com/brunob/leaflet.fullscreen -->
  <script src="/static/leaflet.fullscreen-3.0.2/Control.FullScreen.js"></script>

  <!--Search bar (modified to work with Circles-->
  <script src="/static/leaflet-search/leaflet-search.src.js"></script>

  <!--Values by postcode chart-->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script type="text/javascript">

    // Set the latest year-quarter for data files
    const latest_data_quarter = '2024_Q4';

    // Initialize tooltips once on DOM ready
    $(function () {
      $('[data-bs-toggle="tooltip"]').tooltip();
    });

    $(document).ready(function () {
      var quarterToMonth = {
        'Q1': 'March',
        'Q2': 'June',
        'Q3': 'September',
        'Q4': 'December'
      };
      var match = latest_data_quarter.match(/^(\d{4})_Q([1-4])$/);
      var text = '';
      if (match) {
        var year = match[1];
        var quarter = 'Q' + match[2];
        var month = quarterToMonth[quarter] || '';
        text = month + ' ' + year;
      }
      var el = document.getElementById('latest-data-date');
      if (el) el.textContent = text;
    });

    function showGarageGarden() {
      document.getElementById("garage_col").style.display="block";
      document.getElementById("garden_col").style.display="block";
    }
    function hideGarageGarden() {
      document.getElementById("garage_col").style.display="none";
      document.getElementById("garden_col").style.display="none";
    }

    function getPriceScalingFactor() {
      // Parse latest_data_quarter, e.g. '2024_Q4'
      const quarterToMonth = { Q1: 2, Q2: 5, Q3: 8, Q4: 11 }; // 0-based: Mar, Jun, Sep, Dec
      const match = latest_data_quarter.match(/^(\d{4})_Q([1-4])$/);
      let refYear = 2024, refMonth = 11; // fallback: Dec 2024
      if (match) {
        refYear = parseInt(match[1]);
        refMonth = quarterToMonth['Q' + match[2]];
      }
      const now = new Date();
      const monthsSinceRef = (now.getFullYear() - refYear) * 12 + (now.getMonth() - refMonth);
      return Math.pow(1.02, monthsSinceRef / 12);
    }
    
    let map = L.map('map', {
      center: [54.63, -6.55],
      //zoom: 8.6, zoomSnap: 0.1, //for a good screenshot
      zoom: 8,
      maxZoom: 16,
      minZoom: 8,
      maxBounds: L.latLngBounds(L.latLng(56.0,-10.5), L.latLng(53.0,-3.0)),
      fullscreenControl: true,
    });

    let osmUrl = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
      osm = L.tileLayer(osmUrl, {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright" aria-label="Visit Open Street Map">OpenStreetMap</a> contributors',
        opacity: 0.5
      }), 
      cartoUrl = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', 
      CartoDB_Positron = L.tileLayer(cartoUrl, {
        attribution: '&copy; <a href="https://carto.com/attributions" aria-label="Visit CARTO">CARTO</a>',
        subdomains: 'abcd'
      });

    let baseMaps = {
      "CartoDB": CartoDB_Positron,
      "OpenStreetMap": osm
    };
    CartoDB_Positron.addTo(map);

    //https://stackoverflow.com/questions/37189484/how-to-add-a-search-box-on-a-leaflet-map
    //how does this work without a provider and ArcGIS API key?!
    //var searchControl = new L.esri.Controls.Geosearch().addTo(map);

    function sort_layers(layerA, layerB, nameA, nameB) {
      const my_order = [
        'Postcodes',
        'SOAs',
      ];
      if (my_order.indexOf(nameA) != -1) {
        return my_order.indexOf(nameA) > my_order.indexOf(nameB);
      } else {
        return 1;
      }
    }

    let layerControlPoints = L.control.layers(null, null, {
      position: "topright",
      collapsed: false,
      sortLayers: true,
      sortFunction: sort_layers
    }).addTo(map)

    //add this control below the points one
    let layerControl = L.control.layers(baseMaps, null, {
      position: "topright",
      collapsed: true
    }).addTo(map)

    function populate_clustergroup (csvString, radius, loaded=false) {
      let data;
      if (!loaded) {
        data = Papa.parse(csvString, 
          {header: true, dynamicTyping: true}).data.slice(0,-1);
      } else {
        data = csvString;
      }

      var mcg = L.markerClusterGroup({
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        disableClusteringAtZoom: 15,
        spiderfyOnMaxZoom: false,
        maxClusterRadius: function(zoomLevel) {
          if (zoomLevel <= 8) {
            return 12
          } else if (zoomLevel <= 11) {
            return 16
          } else if (zoomLevel <= 13) {
            return 14
          } else {
            return 12
          }
        },
        removeOutsideVisibleBounds: true,
        iconCreateFunction: function(cluster) {
          var markers = cluster.getAllChildMarkers();
          var colour_list = markers.map(function(value) {
            return value.options.color;
          });
          //https://stackoverflow.com/questions/53509971/get-most-occurring-elements-in-array-javascript
          let colour_counts = colour_list.reduce((a,c) => {
            a[c] = (a[c] || 0) + 1;
            return a;
          }, {});
          let maxCount = Math.max(...Object.values(colour_counts));
          let mostFrequent = Object.keys(colour_counts).filter(
            k => colour_counts[k] === maxCount);
          return L.divIcon({
            iconSize: 10,
            //set the border-radius is 50% and background-color is the most frequent colour
            className: 'dummy',
            html: '<div style="border-radius:50%; background-color:' + mostFrequent[0] + '; width: 11px; height: 11px;"></div>'
          });  
        },
        chunkedLoading: true,
      });

      const price_scaling_factor = getPriceScalingFactor();

      // Helper to get minimum radius based on zoom
      function getMinRadius(zoom) {
        // For zoom levels 14 and below (when clusters are active), use a minimum radius based on zoom level.
        // This ensures circles are always visible at lower zoom levels, but also not larger than the clusters at any point.
        // At 14,15,16, the floor of 30 will apply.
        return Math.max(30, 240 / Math.pow(2, zoom - 10));
      }

      const circles = data.map(row => {
        // Scale values in popup_text
        let popup = row.popup_text;
        // Scale 'Mean value £121,572'
        popup = popup.replace(/Mean value £([\d,]+)/, function(match, val) {
          let scaled = Math.round(parseInt(val.replace(/,/g,'')) * price_scaling_factor);
          return 'Mean value £' + scaled.toLocaleString();
        });
        // Scale '£311</b> per sq. m' (with optional <b> tag)
        popup = popup.replace(/£([\d,]+)(<\/b>)? per sq\. m/, function(match, val, btag) {
          let scaled = Math.round(parseInt(val.replace(/,/g,'')) * price_scaling_factor);
          return '£' + scaled.toLocaleString() + (btag || '') + ' per sq. m';
        });

        // Set initial radius with minimum threshold
        let mapZoom = map.getZoom ? map.getZoom() : 8;
        let minRadius = getMinRadius(mapZoom);
        let circleRadius = Math.max(radius, minRadius);

        var circle = L.circle([row.latitude, row.longitude], {
          radius: circleRadius, 
          color: row.html_colour, 
          fillColor: row.html_colour,
          opacity: 1, 
          weight: 2,
          fillOpacity: 0.3,
        }).bindPopup(
          popup
        ).on(
          'mouseover', function(e) {
            e.target.setStyle({
              weight: 5,
              fillOpacity: 0.6
            }),
            e.target.setRadius(Math.max(radius*1.2, getMinRadius(map.getZoom())));
          }
        ).on(
          'mouseout', function(e) {
            e.target.setStyle({
              weight: 2,
              fillOpacity: 0.3
            }),
            e.target.setRadius(Math.max(radius, getMinRadius(map.getZoom())));
          }
        );
        circle['searchText'] = popup.split('</b>')[0].slice(3);
        return circle;
      });

      // Update all circle radii on zoom to maintain minimum size
      map.on('zoomend', function() {
        let zoom = map.getZoom();
        circles.forEach(function(circle) {
          circle.setRadius(Math.max(radius, getMinRadius(zoom)));
        });
      });

      mcg.addLayers(circles);
      return mcg;
    }

    function highlightSOAOnMouseover(feature, layer) {
      layer.on({
        mouseover: function (e) {
          e.target.setStyle({
            weight: 2.5,
            fillOpacity: 0.5
          });
          if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
              layer.bringToFront();
          }
        },
        mouseout: function (e) {props_gj.resetStyle(e.target)}
      });
    };

    // Colourbar
    var legend = L.control({position: 'bottomright'});
    //added within colour band csv read in below

    // Map footer
    map.attributionControl.setPrefix('');

    let pns_short, pns_long;
    let calculator_coefs_houses, calculator_coefs_flats;
    let colour_bands_soas;

    function run_calculator() {
      let form_map = new Map();
      $.each($("#calc_form").serializeArray(), function(i, field) {
        form_map.set(field.name, field.value);
      });

      form_map.set('calc_hometype_House', false);
      form_map.set('calc_hometype_Flat', false);
      var radios = document.getElementsByName('calc_hometype');
      $.each(radios, function(i, field) {
        if (field.checked) {
          if (field.id === 'calc_hometype_h') {
            form_map.set('calc_hometype_House', true);
          } else {
            form_map.set('calc_hometype_Flat', true);
          }
        }
      });

      let coefs = new Map();
      let coefs_lower = new Map();
      let coefs_upper = new Map();
      if (form_map.get('calc_hometype_House')) {
        $.each(calculator_coefs_houses, function(i, field) {
          coefs.set(field.coef, parseFloat(field.value_mean.toFixed(4)));
          if (field.value_lower !== null) {
            coefs_lower.set(field.coef, parseFloat(field.value_lower.toFixed(2)));
            coefs_upper.set(field.coef, parseFloat(field.value_upper.toFixed(2)));
          }
        });
      } else {
        $.each(calculator_coefs_flats, function(i, field) {
          coefs.set(field.coef, parseFloat(field.value_mean.toFixed(4)));
          if (field.value_lower !== null) {
            coefs_lower.set(field.coef, parseFloat(field.value_lower.toFixed(2)));
            coefs_upper.set(field.coef, parseFloat(field.value_upper.toFixed(2)));
          }
        });
      }

      if (coefs.has(form_map.get('calc_postcode').trim().toUpperCase())) {
        let postcode_choice = form_map.get('calc_postcode').trim().toUpperCase();
        let pred_ppsqm = 0.0;
        let price_string = "Typical price for a ";

        if (form_map.get('calc_newbuild_yn') == 'Yes') {
          price_string += 'new build '
        }

        //radio button house/flat appears only as the one selected with value 'on'
        if (form_map.get('calc_hometype_House')) {
          price_string += "<b>house</b> "
        } else {
          price_string += "<b>flat</b> "
        }

        price_string += "with area <b>" + parseInt(form_map.get('calc_size')) + "m<sup>2</sup></b> "

        if (form_map.get('calc_hometype_House')) {
          if (form_map.get('calc_garage_yn') == 'Yes') {
            pred_ppsqm += coefs.get('has_garage_01');
            price_string += "and a garage "
          }

          if (form_map.get('calc_garden_yn') == 'Yes') {
            pred_ppsqm += coefs.get('has_garden_01');
            price_string += "and a garden "
          }
        }

        pred_ppsqm += coefs.get('area_m2') * parseInt(form_map.get('calc_size'));
        pred_ppsqm += coefs.get('area_squared') * parseInt(form_map.get('calc_size'))**2;
        if (parseInt(form_map.get('calc_size')) < 60) {
          pred_ppsqm += coefs.get('area_lt_60_01');
        }
        // This is the base; different postcode terms can be added to this below.

        pred_ppsqm_mean = pred_ppsqm + coefs.get(postcode_choice);
        pred_ppsqm_lower = pred_ppsqm + coefs_lower.get(postcode_choice);
        pred_ppsqm_upper = pred_ppsqm + coefs_upper.get(postcode_choice);
        price_string += "in <b>" + postcode_choice + "</b>, is "

        //*1.4 for new build
        if (form_map.get('calc_newbuild_yn') == 'Yes') {
          pred_ppsqm_mean *= 1.4;
          pred_ppsqm_lower *= 1.4;
          pred_ppsqm_upper *= 1.4;
          // If only a short postcode is provided, move the mean
          //   prediction to the 70th percentile for the short postcode,
          //   assuming the new build will be in an above-average part of it.
          if (postcode_choice.length <= 4) {
            pred_ppsqm_mean = pred_ppsqm_lower + 0.70*(pred_ppsqm_upper-pred_ppsqm_lower)
          }
        }

        // scale to today's prices
        const scaling_factor = getPriceScalingFactor();
        pred_ppsqm_mean = pred_ppsqm_mean * scaling_factor;
        pred_ppsqm_lower = pred_ppsqm_lower * scaling_factor;
        pred_ppsqm_upper = pred_ppsqm_upper * scaling_factor;

        //This is price per sq metre; now scale to area
        pred_price_mean = 1000*(parseInt(pred_ppsqm_mean) * parseInt(form_map.get('calc_size')) / 1000).toFixed(0);
        pred_price_lower = 1000*(parseInt(pred_ppsqm_lower) * parseInt(form_map.get('calc_size')) / 1000).toFixed(0);
        pred_price_upper = 1000*(parseInt(pred_ppsqm_upper) * parseInt(form_map.get('calc_size')) / 1000).toFixed(0);
        // a few postcodes have small samples and sometimes zero std dev; expand the range to something sensible
        if (pred_price_lower > 0.95 * pred_price_mean) {
          pred_price_lower = 1000*(0.95 * pred_price_mean / 1000).toFixed(0);
        }
        if (pred_price_upper < 1.05 * pred_price_mean) {
          pred_price_upper = 1000*(1.05 * pred_price_mean / 1000).toFixed(0);
        }
       
        $('#calc_output_1').html(price_string);

        price_string = ` <span style='font-size: 1.8em; color: dodgerblue'><b>£${pred_price_mean.toLocaleString()}</b></span>`
        price_string += ` (<b>£${pred_price_lower.toLocaleString()}&ndash;${pred_price_upper.toLocaleString()}</b>)`
        $('#calc_output_2').html(price_string);

        let nearest_postcodes = pns_short.concat(pns_long).filter(
          function(value) { 
            return value.postcode==postcode_choice
          })[0];
        let comparison_string = "The same property in nearby postcodes would cost, on average,<ul>"

        var npc_hits = 0;
        for (i = 1; i <= 5; i++) {
          var near_pc = nearest_postcodes[`nearest_pcs_${i}`];
          
          if (coefs.get(near_pc) !== undefined) {
            npc_hits += 1;
            near_pc_pred_ppsqm_mean = pred_ppsqm + coefs.get(near_pc);
            near_pc_pred_ppsqm_lower = pred_ppsqm + coefs_lower.get(near_pc);
            near_pc_pred_ppsqm_upper = pred_ppsqm + coefs_upper.get(near_pc);

            //*1.4 for new build
            if (form_map.get('calc_newbuild_yn') == 'Yes') {
              near_pc_pred_ppsqm_mean *= 1.4;
              near_pc_pred_ppsqm_lower *= 1.4;
              near_pc_pred_ppsqm_upper *= 1.4;
              //and mean to 70th percentile for these short postcodes
              near_pc_pred_ppsqm_mean = near_pc_pred_ppsqm_lower + 0.70*(near_pc_pred_ppsqm_upper-near_pc_pred_ppsqm_lower)
            }

            // scale to today's prices
            near_pc_pred_ppsqm_mean = near_pc_pred_ppsqm_mean * scaling_factor;
            near_pc_pred_ppsqm_lower = near_pc_pred_ppsqm_lower * scaling_factor;
            near_pc_pred_ppsqm_upper = near_pc_pred_ppsqm_upper * scaling_factor;

            near_pc_pred_price_mean = 1000*(parseInt(near_pc_pred_ppsqm_mean) * parseInt(form_map.get('calc_size')) / 1000).toFixed(0);
            near_pc_pred_price_lower = 1000*(parseInt(near_pc_pred_ppsqm_lower) * parseInt(form_map.get('calc_size')) / 1000).toFixed(0);
            near_pc_pred_price_upper = 1000*(parseInt(near_pc_pred_ppsqm_upper) * parseInt(form_map.get('calc_size')) / 1000).toFixed(0);
            // a few postcodes have small samples and sometimes zero std dev; expand the range for the plot
            if (near_pc_pred_price_lower > 0.95 * near_pc_pred_price_mean) {
              near_pc_pred_price_lower = 1000*(0.95 * near_pc_pred_price_mean / 1000).toFixed(0);
            }
            if (near_pc_pred_price_upper < 1.05 * near_pc_pred_price_mean) {
              near_pc_pred_price_upper = 1000*(1.05 * near_pc_pred_price_mean / 1000).toFixed(0);
            }

            comparison_string += `<li>in ${near_pc}, <b>£${near_pc_pred_price_mean.toLocaleString()}</b> (£${near_pc_pred_price_lower.toLocaleString()}&ndash;${near_pc_pred_price_upper.toLocaleString()}) `
            if (near_pc_pred_price_mean > pred_price_mean + 1000) {
              comparison_string += "<span style='color: red; font-weight: bold; font-size: 1.2em'>&nearr;</span>"
            } else if (near_pc_pred_price_mean < pred_price_mean - 1000) {
              comparison_string += "<span style='color: green; font-weight: bold; font-size: 1.2em'>&searr;</span>"
            }
            comparison_string += '</li>'
          }
          if (npc_hits == 3) break;
        }
        comparison_string += '</ul>'

        $('#calc_output_3').html(comparison_string);

        // do the same for all postcodes
        const all_short_postcodes = Array.from(coefs.keys()).filter(key => key.startsWith('BT')).filter(key => key.length <= 4);
        // if we are doing a long postcode, add it to this list
        if (postcode_choice.length > 4) {
          all_short_postcodes.push(postcode_choice);
        }
        let allpc_values = new Array(all_short_postcodes.length);
        for (i = 1; i <= all_short_postcodes.length; i++) {
          var near_pc = all_short_postcodes[i-1];
          
          if (coefs.get(near_pc) !== undefined) {
            near_pc_pred_ppsqm_mean = pred_ppsqm + coefs.get(near_pc);
            near_pc_pred_ppsqm_lower = pred_ppsqm + coefs_lower.get(near_pc);
            near_pc_pred_ppsqm_upper = pred_ppsqm + coefs_upper.get(near_pc);

            //*1.4 for new build
            if (form_map.get('calc_newbuild_yn') == 'Yes') {
              near_pc_pred_ppsqm_mean *= 1.4;
              near_pc_pred_ppsqm_lower *= 1.4;
              near_pc_pred_ppsqm_upper *= 1.4;
              //and mean to 70th percentile for these short postcodes
              near_pc_pred_ppsqm_mean = near_pc_pred_ppsqm_lower + 0.70*(near_pc_pred_ppsqm_upper-near_pc_pred_ppsqm_lower)
            }

            // scale to today's prices
            near_pc_pred_ppsqm_mean = near_pc_pred_ppsqm_mean * scaling_factor;
            near_pc_pred_ppsqm_lower = near_pc_pred_ppsqm_lower * scaling_factor;
            near_pc_pred_ppsqm_upper = near_pc_pred_ppsqm_upper * scaling_factor;

            near_pc_pred_price_mean = 1000*(parseInt(near_pc_pred_ppsqm_mean) * parseInt(form_map.get('calc_size')) / 1000).toFixed(0);
            near_pc_pred_price_lower = 1000*(parseInt(near_pc_pred_ppsqm_lower) * parseInt(form_map.get('calc_size')) / 1000).toFixed(0);
            near_pc_pred_price_upper = 1000*(parseInt(near_pc_pred_ppsqm_upper) * parseInt(form_map.get('calc_size')) / 1000).toFixed(0);
            // a few postcodes have small samples and sometimes zero std dev; expand the range for the plot
            if (near_pc_pred_price_lower > 0.95 * near_pc_pred_price_mean) {
              near_pc_pred_price_lower = 1000*(0.95 * near_pc_pred_price_mean / 1000).toFixed(0);
            }
            if (near_pc_pred_price_upper < 1.05 * near_pc_pred_price_mean) {
              near_pc_pred_price_upper = 1000*(1.05 * near_pc_pred_price_mean / 1000).toFixed(0);
            }
            allpc_values[i-1] = {
              postcode: near_pc,
              lower: near_pc_pred_price_lower,
              mean: near_pc_pred_price_mean,
              upper: near_pc_pred_price_upper
            };
          }
        }

        let allpc_values_sorted_by_value = allpc_values.sort(function(a, b) {return a.mean - b.mean});
        
        const ctx = document.getElementById('calculator_output_chart').getContext('2d');
        if (typeof(postcode_chart) !== 'undefined') {
          postcode_chart.clear();
          postcode_chart.destroy();
        } else {
          document.getElementById('calculator_output_chart').style.display = 'block';
        }

        postcode_chart = new Chart(ctx, {
          data: {
            labels: allpc_values_sorted_by_value.map(arr => arr.postcode).filter((postcode, index) => index % 3 === 0 || index === allpc_values_sorted_by_value.length - 1 || postcode === postcode_choice),
            datasets: [
              {
                data: allpc_values_sorted_by_value.filter((arr, index) => index % 3 === 0 || index === allpc_values_sorted_by_value.length - 1 || arr.postcode === postcode_choice).map(arr => [arr.lower, arr.upper]),
                type: 'bar',
                backgroundColor: "lightsteelblue",
                borderWidth: 0,
                barThickness: 5,
                order: 1,
              },
              {
                data: [{x: pred_price_mean, y: postcode_choice}],
                type: 'scatter',
                backgroundColor: 'brown',
                pointRadius: 7,
                order: 0,
              }
            ]
          },
          options: {
            indexAxis: 'y',
            scales: {
              x: {
                type: 'linear',
                position: 'bottom',
                min: Math.round((Math.min(...allpc_values_sorted_by_value.map(arr => arr.lower))-20000)/50000) * 50000,
                max: Math.round((Math.max(...allpc_values_sorted_by_value.map(arr => arr.upper))+20000)/50000) * 50000,
                ticks: {
                  callback: function(value, index, ticks) {
                    return '£' + value.toLocaleString();
                  },
                },
              },
              y: {
                type: 'category',
                position: 'left',
                // ticks: {
                //   callback: function(val, index) {
                //     return this.getLabelForValue(val) === postcode_choice ? postcode_choice : null;
                //   }
                // },
              }
            },
            //remove legend
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  title: function(context) { 
                    if (context[0].dataset.type == 'scatter') {
                      return context[0].raw.y;
                    } else {
                      return context[0].label;
                    }
                  },
                  label: function(context) {
                    if (context.dataset.type == 'scatter') {
                      return '£' + context.raw.x.toLocaleString();
                    } else {
                      return '£' + context.raw[0].toLocaleString() + '-' + context.raw[1].toLocaleString();
                    }
                  }
                }
              },
            }
          }
        })

      } else {
        $('#calc_output_1').html('Postcode <b>not found</b> (for this property type)');
        $('#calc_output_2').html(null);
        $('#calc_output_3').html(null);
        if (typeof(postcode_chart) !== 'undefined') {
          postcode_chart.clear();
          postcode_chart.destroy();
        }
      }

      $('html, body').animate({
        scrollTop: $('#calc_output_1').offset().top - 10
      }, 600);

      return false;
    }

    // Legend changes
    function get_legend_label_from_colour_bands_array(o, index, arr) {
      var lab = '<i style="background: ' + o.html_colour + '"></i>';
      if (index == 0) {
        lab += 'Most';
      } else if (index == 1) {
        lab += 'expensive'
      } else if (arr.length == 7 && index == 3) {
        lab += 'Average';
      } else if (index == arr.length-2) {
        lab += 'Least';
      } else if (index == arr.length-1) {
        lab += 'expensive';
      }
      return lab;
    }
    map.on('baselayerchange', function(e) { 
      if (e.name == 'SOAs') {
      var new_labels = colour_bands_soas.map(get_legend_label_from_colour_bands_array);
      $('.legend')[0].innerHTML = new_labels.join('<br>');
      } else if (e.name == 'Postcodes') {
      var new_labels = colour_bands_glmmethod.map(get_legend_label_from_colour_bands_array);
      $('.legend')[0].innerHTML = new_labels.join('<br>');
      }
    });

    // Data table and read in other csvs
    $(document).ready(function() {

      $.ajax({
        beforeSend: function() {
          $('#loading').show();
        },
        complete: function() {
          $('#loading').hide();
        },
        url: `./static/ppsqm_nge10_glmmethod_smoothed_alpha3000_${latest_data_quarter}.csv`,
        dataType: 'text',
        success: function(data) {
          allpts_data = Papa.parse(data, {
            header: true,
            dynamicTyping: true,
          }).data.slice(0,-1);
          
          props_glm = populate_clustergroup(allpts_data, 30, loaded=true);
          props_glm.addTo(map);
          layerControlPoints.addBaseLayer(props_glm, 'Postcodes');

          //Search by postcode in local data
          var controlSearch = new L.Control.Search({
            position:'topleft',
            layer: props_glm,
            propertyName: 'searchText',
            initial: false,
            zoom: 16,
            marker: false,
            minLength: 3,
            tooltipLimit: 5,
            textPlaceholder: 'Search postcode...'
          });
          map.addControl(controlSearch);

          $('#postcodes-all-table').DataTable( {
            responsive: true,
            data: allpts_data,
            columns: [
                { data: "Postcode", 
                  render: function(data) {return '<b>'+data+'</b>'},
                  responsivePriority: 1, searchable: true},
                { data: "mean_size", title: "Average size",
                  render: DataTable.render.number(',', '.', 0, null, ' sq. m'),
                  responsivePriority: 4,
                  searchable: false },
                { data: "mean_val",
                  title: "Average price",
                  render: DataTable.render.number(',', '.', 0, '£', null),
                  responsivePriority: 3,
                  searchable: false },
                { data: "ppsqm_delta",
                  title: "Price per sq. m compared to average",
                  render: DataTable.render.number(',', '.', 0, '£', null),
                  responsivePriority: 2,
                  searchable: false },
            ],
            ordering: true,
            searching: true,
            //https://datatables.net/forums/discussion/46736/search-for-data-table-is-very-slow
            //https://datatables.net/reference/option/searchDelay
            //searchDelay: 800
            search: {
              return: true,
              smart: false,
              regex: false
            },
          } );
        }
      });

      // colour bands
      Papa.parse(`./static/colour_bands_ppsqm_nge10_glmmethod_${latest_data_quarter}.csv`, {
        header: true, download: true, dynamicTyping: true,
        complete: function(results) {
          colour_bands_glmmethod = results.data.slice(0,-1).reverse();

          legend.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'info legend')
            var labels = colour_bands_glmmethod.map(get_legend_label_from_colour_bands_array);
            div.innerHTML = labels.join('<br>');
            return div;
          };
          legend.addTo(map);
        }
      });
      Papa.parse(`./static/colour_bands_ppsqm_nge10_LSOAglmmethod_${latest_data_quarter}.csv`, {
        header: true, download: true, dynamicTyping: true,
        complete: function(results) {
          colour_bands_soas = results.data.slice(0,-1).reverse();
        }
      });

      //Geojson layer for SOA
      $.get(`./static/ppsqm_nge10_LSOAglmmethod_${latest_data_quarter}.json`, function(geojsonString) {
        props_gj = L.geoJson(geojsonString, {
          style: function (feature) {
            return {
              color: feature.properties.html_colour,
              fillOpacity: 0.3,
              weight: 1
            };
          },
          onEachFeature: highlightSOAOnMouseover
        }).bindPopup(function (layer) {
          return layer.feature.properties.popup_text;
        });
        layerControlPoints.addBaseLayer(props_gj, 'SOAs');
      });

      // calculator coefficients
      Papa.parse(`./static/calculator_coefs_houses_smoothed_alpha3000_${latest_data_quarter}.csv`, {
        header: true,
        download: true,
        dynamicTyping: true,
        complete: function(results) {
          calculator_coefs_houses = results.data.slice(0,-1);
        }
      });
      Papa.parse(`./static/calculator_coefs_flats_smoothed_alpha3000_${latest_data_quarter}.csv`, {
        header: true,
        download: true,
        dynamicTyping: true,
        complete: function(results) {
          calculator_coefs_flats = results.data.slice(0,-1);
        }
      });

      // nearest postcodes for calculator
      Papa.parse('./static/postcodeshort_nearest_five.csv', {
        header: true,
        download: true,
        dynamicTyping: false,
        complete: function(results) {
          pns_short = results.data.slice(0,-1);
        }
      });
      Papa.parse('./static/postcodelongtoshort_nearest_five.csv', {
        header: true,
        download: true,
        dynamicTyping: false,
        complete: function(results) {
          pns_long = results.data.slice(0,-1);
        }
      });

    });

  </script>

</body>
</html>