<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>NI Property Prices</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin=""/>

    <!-- Bootstrap -->
    <link href="https://getbootstrap.com/docs/5.2/dist/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="https://cdn.datatables.net/1.11.4/css/dataTables.bootstrap4.min.css" rel="stylesheet" type="text/css">

    <!-- Fonts -->
    <link href='https://fonts.googleapis.com/css2?family=Gafata&display=swap' rel='stylesheet'>
    <link href="/static/fontawesome-free-5.15.1-web/css/all.css" rel="stylesheet">

    <!--jquery UI autocomplete -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

    <!-- My styling -->
    <link href='/static/hp_style.css' rel="stylesheet" type="text/css">

    <!-- Favicon for browser tab -->

    <style>
      .legend { text-align: left; line-height: 14px; color: #555; padding: 6px 8px; background: white; box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; }
      .legend i { width: 14px; height: 14px; float: left; margin-right: 8px; opacity: 0.7; }
    </style>

</head>

<body>
  
  <header>
    <div class='container'>
      <div class='row my-4 justify-content-md-center'>
        <div class='col-md-8'>
          <h1>The Northern Ireland Property Price Map</h1>
          
          <p>This shows the estimated value added to a property, per square metre, in 2022 prices, by each postcode in Northern Ireland. The price of two properties with equal characteristics (type, size, garage, etc.) will vary due to their location, with some postcodes boosting the price per square metre above the national average and others bringing it down below the average.</p>

          <p>The map data can be viewed by individual postcode, or with postcodes grouped together, either on a regular grid, or by government Super Output Areas (SOAs) <span class='help-tooltip' title='A NISRA geography that divides Northern Ireland into 890 areas of approximately equal population' data-toggle="tooltip"><i class="fas fa-question-circle fa-sm"></i></span>. Data can be filtered to show only houses or only flats/apartments.</p>
          <!--https://www.opendatani.gov.uk/blog/data-aggregation-levels-of-geography-in-ni-->
          
          <p>Property data, including 2005 valuations, are from <a href='https://www.finance-ni.gov.uk/topics/property-valuation/domestic-valuation'>Land & Property Services.</a> These values are updated to 2022 using <a href='https://www.finance-ni.gov.uk/articles/northern-ireland-house-price-index'>NISRA's Northern Ireland House Price Index</a>, but only at the granularity of local government district (LGD) level. Price levels and the high-level structure of the map are therefore representative of 2022, but small-scale patterns shown are from 2005, and may have changed slightly since then, where some areas within an LGD have become relatively more desirable than others.</p>
          
          <p>The calculator below runs on a simple model of property price, and can be used to estimate what combinations of location and property characteristics are affordable on your budget. Property value is modelled as</p>

          <p style='display: block; font-style: italic;'>PricePerSquareMetre ~ HouseOrFlat + HasGarage + HasGarden + Postcode</p>

          <p>and coefficients are fitted for each of the predictor terms. The postcode coefficients are what is shown in the map. These terms capture <i>the value of the area itself</i>, independent of the particular kinds of properties (size, etc.) that are found in the area.</p>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class='container'>

      <div class='row justify-content-md-center'>
        <div class='col-md-12'>
          <div id="map" class="map map-home" style="height: 600px; margin-top: 30px"></div>
        </div>
      </div>


      <div class='row my-4 justify-content-md-center'>
        <div class='col-lg-8 col-md-10 col-sm-12'>

          <div class="row no-gutters border rounded overflow-hidden flex-md-row mb-4 shadow-sm h-md-250 position-relative">
            <div class="col py-4 pl-2 pr-4 d-flex flex-column position-static">
              <h4>Price calculator</h4>
              
              <p>Enter details of a hypothetical property and a postcode (either half or full), and a calculator based on the price per square metre model returns the typical expected 2022 price for that property.</p>
              
              <form class='row mx-2 my-2 needs-validation' id='calc_form' onsubmit='return run_calculator()'>

                <div class='col-lg-6 col-md-4 mb-2'>
                  <div id='calc_hometype_help' class='form-text mb-2'>I'm looking for a ...</div>
                  <input type="radio" class="form-check-input" id="calc_hometype_h" name='calc_hometype' aria-describedby='calc_hometype_help' checked>
                  <label for="calc_hometype_h" class="form-label">House</label>
                
                  <input type="radio" class="form-check-input px-2" id="calc_hometype_f" name='calc_hometype' aria-describedby='calc_hometype_help'>
                  <label for="calc_hometype_f" class="form-label">Flat</label>
                </div>

                <div class="col-lg-3 col-md-4 mb-2">
                  <label class="form-label" for="calc_garage_yn">With garage (if house)?</label>
                  <select class="form-select" id="calc_garage_yn" name='calc_garage_yn'>
                    <option selected>Yes</option>
                    <option>No</option>
                  </select>
                </div>
                <div class="col-lg-3 col-md-4 mb-2">
                  <label class="form-label" for="calc_garden_yn">With garden (if house)?</label>
                  <select class="form-select" id="calc_garden_yn" name='calc_garden_yn'>
                    <option selected>Yes</option>
                    <option>No</option>
                  </select>
                </div>

                <div class="col-6 mb-2">
                  <label for='calc_size' class='form-label mx-2'>...with floor size:</label>
                  <!--<input type="text" class="form-control" aria-label="calc_size" id='calc_size' name='calc_size' placeholder="Area in m&sup2;" required>-->
                  <input type='number' min=10 max=500 class='form-control' aria-label='calc_size' id='calc_size' name='calc_size' placeholder='Area in m&sup2;' required>
                </div>

                <div class="col-6 mb-2">
                  <label for="calc_postcode" class="form-label mx-2">...in postcode:</label>
                  <input type="text" class="form-control" id="calc_postcode" name='calc_postcode' placeholder="Enter postcode, half or full"  required>
                  <div class="invalid-feedback">Please provide a valid postcode.</div>
                </div>
                
                <div class='col-12'>
                  <button type="submit" class="btn btn-primary">Calculate</button>
                </div>
              </form>

              <p id='calc_output'></p>

              <p id='calc_output_2'></p>
            </div>
          </div>

        </div>
      </div>

      <div class='row my-4 justify-content-md-center'>
        <div class='col-md-10'>

          <div class="row no-gutters border rounded overflow-hidden flex-md-row mb-4 shadow-sm h-md-250 position-relative">
            <div class="col py-4 px-2 d-flex flex-column position-static">
              <h4>Postcode lookup</h4>

              <p>Only postcodes with at least 10 domestic properties, of type House or Flat, in the LPS data are included. <i>TODO include size?</i></p>
              
              <table id="postcodes-all-table" class="table table-striped table-bordered" style='width: 100%; font-size: 0.9em'>
                <thead>
                  <tr>
                    <th>Postcode</th>
                    <th>SOA</th>
                    <th>Number of properties</th>
                    <th>Mean price per m<sup>2</sup></th>
                    <th>Mean actual price</th>
                    <th>Longitude</th>
                    <th>Latitude</th>
                  </tr>
                </thead>
              </table>

            </div>
          </div>

        </div>
      </div>

    </div>
    
  </main>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>

  <!-- Load jQuery and PapaParse to read data from a CSV file -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  <!-- Popper.JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.4/js/dataTables.bootstrap4.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.3.0/js/dataTables.responsive.min.js"></script>

  <!--jquery UI autocomplete -->
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

  <script type="text/javascript">

    //TODO something to fix this
    // $(function () {
    //   $('[data-toggle="tooltip"]').tooltip()
    // });
    
    let map = L.map('map').setView([54.60, -5.94], 11);

    let osmUrl = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
      osmAttrib = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      osm = L.tileLayer(osmUrl, {
        maxZoom: 16, 
        minZoom: 8,
        attribution: osmAttrib});

    let CartoDB_Positron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 16,
      minZoom: 8
    });

    let baseMaps = {
      "CartoDB Positron": CartoDB_Positron,
      "OpenStreetMap": osm
    };

    CartoDB_Positron.addTo(map);

    //TODO look at tab header for layers https://github.com/HandsOnDataViz/leaflet-map-polygon-tabs

    function sort_layers(layerA, layerB, nameA, nameB) {
      const my_order = [
        '50x50 grid', 
        'SOAs',
        'Postcodes',
        'Postcodes - Houses', 
        'Postcodes - Flats',
        'Postcodes - All'
      ];
      if (my_order.indexOf(nameA) != -1) {
        return my_order.indexOf(nameA) > my_order.indexOf(nameB);
      } else {
        return 1;
      }
    }

    let layerControlPoints = L.control.layers(null, null, {
      position: "topright",
      collapsed: false,
      sortLayers: true,
      sortFunction: sort_layers
    }).addTo(map)

    //add this control below the points one
    let layerControl = L.control.layers(baseMaps, null, {
      position: "topright",
      collapsed: true
    }).addTo(map)

    function make_circles_layer_group (csvString, radius) {
      let data = Papa.parse(csvString, {header: true, dynamicTyping: true}).data;

      const circles_2 = [];
      for (var i = 0; i < data.length-1; i++) {
        var row = data[i];
        
        var circle = L.circle([row.latitude, row.longitude], {
          radius: radius, 
          color: row.html_colour, 
          opacity: 1, 
          weight: 2,
          fillOpacity: 0.3
        }).bindPopup(
            row.popup_text
          ).on(
            'mouseover', function(e) {
              e.target.setStyle({
                weight: 5,
                fillOpacity: 0.6
              }),
              e.target.setRadius(radius*1.2)
            }
          ).on(
            'mouseout', function(e) {
              e.target.setStyle({
                weight: 2,
                fillOpacity: 0.3
              }),
              e.target.setRadius(radius)
            }
          );

        circles_2.push(circle);
      }
      return L.layerGroup(circles_2);
    }

    let props_glm;

    $.get('./static/ppsqm_nge10_glmmethod_houses.csv', function(csvString) {
      layerControlPoints.addBaseLayer(
        make_circles_layer_group(csvString, 30), 'Postcodes - Houses');
    });

    $.get('./static/ppsqm_nge10_glmmethod_flats.csv', function(csvString) {
      layerControlPoints.addBaseLayer(
        make_circles_layer_group(csvString, 60), 'Postcodes - Flats');
    });

    $.get('./static/ppsqm_nge10_glmmethod.csv', function(csvString) {
      props_glm = make_circles_layer_group(csvString, 30);
      props_glm.addTo(map);      
      layerControlPoints.addBaseLayer(props_glm, 'Postcodes - All');
    });

    // Geojson layer for SOA
    $.get('./static/ppsqm_nge10_LSOAglmmethod.json', function(geojsonString) {
      props_gj = L.geoJson(geojsonString, {
        style: function (feature) {
          return {
            color: feature.properties.html_colour,
            fillOpacity: 0.3,
            weight: 1
          };
        },
        onEachFeature: onEachFeature
      }).bindPopup(function (layer) {
        return layer.feature.properties.popup_text;
      });
      layerControlPoints.addBaseLayer(props_gj, 'SOAs');
    });

    function onEachFeature(feature, layer) {
      layer.on({
        mouseover: function (e) {
          var layer = e.target;

          layer.setStyle({
            weight: 2.5,
            fillOpacity: 0.5
          });

          if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
              layer.bringToFront();
          }
        },
        mouseout: function (e) {props_gj.resetStyle(e.target)}
      });
    };

    //TODO try https://github.com/ismyrnow/leaflet-groupedlayercontrol

    // map.on('zoomend', function(e) {
    //   if (e.sourceTarget._zoom == 12) {
    //     console.log('Zoom = 12 so may make circles bigger');
    //     props_glm.eachLayer(function(layer) {
    //       layer.setRadius(50);
    //     });
    //   } else if (e.sourceTarget._zoom == 11) {
    //     console.log('Zoom = 11, back to original size');
    //     props_glm.eachLayer(function(layer) {
    //       layer.setRadius(30);
    //     });
    //   } else if (e.sourceTarget._zoom == 9) {
    //     console.log('Zoom = 9 so may make circles smaller');
    //     props_glm.eachLayer(function(layer) {
    //       layer.setRadius(300);
    //     });
    //   } else if (e.sourceTarget._zoom == 10) {
    //     console.log('Zoom = 10, back to original size');
    //     props_glm.eachLayer(function(layer) {
    //       layer.setRadius(30);
    //     });
    //   }
    // });

    // Colourbar
    var legend = L.control({position: 'bottomright'});
    //added within colour band csv read in below

    // Map footer
    map.attributionControl.setPrefix(
      'View <a href="https://github.com/viva-ronaldo" target="_blank">code on GitHub</a>'
    );

    let pns_short, pns_long;
    let calculator_coefs;
    let colour_bands_flats, colour_bands_houses, colour_bands_soas;

    function run_calculator() {
      let form_map = new Map();
      $.each($("#calc_form").serializeArray(), function(i, field) {
        form_map.set(field.name, field.value);
      });

      form_map.set('calc_hometype_House', false);
      form_map.set('calc_hometype_Flat', false);
      var radios = document.getElementsByName('calc_hometype');
      $.each(radios, function(i, field) {
        if (field.checked) {
          if (field.id === 'calc_hometype_h') {
            form_map.set('calc_hometype_House', true);
          } else {
            form_map.set('calc_hometype_Flat', true);
          }
        }
      });

      let coefs = new Map();
      let coefs_pc10 = new Map();
      let coefs_pc90 = new Map();
      $.each(calculator_coefs, function(i, field) {
        coefs.set(field.coef, parseFloat(field.value_mean.toFixed(2)));
        if (field.value_pc10 !== null) {
          coefs_pc10.set(field.coef, parseFloat(field.value_pc10.toFixed(2)));
          coefs_pc90.set(field.coef, parseFloat(field.value_pc90.toFixed(2)));
        }
      });

      if (coefs.has(form_map.get('calc_postcode').trim())) {
        let pred_ppsqm = 0.0;
        let price_string = "Typical price for a ";

        pred_ppsqm += coefs.get('const');

        //radio button house/flat appears only as the one selected with value 'on'
        if (form_map.get('calc_hometype_House')) {
          pred_ppsqm += coefs.get('home_type_House');
          price_string += "<b>house</b> "
        } else {
          pred_ppsqm += coefs.get('home_type_Flat');
          price_string += "<b>flat</b> "
        }

        // pred_ppsqm += parseInt(form_map.get('calc_size'))*coefs.get('area_m2');
        price_string += "with area <b>" + parseInt(form_map.get('calc_size')) + "m<sup>2</sup></b> "

        if (form_map.get('calc_hometype_House')) {
          if (form_map.get('calc_garage_yn') == 'Yes') {
            pred_ppsqm += coefs.get('has_garage_01');
            price_string += "and a garage "
          }

          if (form_map.get('calc_garden_yn') == 'Yes') {
            pred_ppsqm += coefs.get('has_garden_01');
            price_string += "and a garden "
          }
        }

        pred_ppsqm_mean = pred_ppsqm + coefs.get(form_map.get('calc_postcode').trim());
        pred_ppsqm_pc10 = pred_ppsqm + coefs_pc10.get(form_map.get('calc_postcode').trim());
        pred_ppsqm_pc90 = pred_ppsqm + coefs_pc90.get(form_map.get('calc_postcode').trim());
        price_string += "in <b>" + form_map.get('calc_postcode').trim() + "</b>, is "

        //This is price per sq metre; now scale to area
        pred_price_mean = 1000*(parseInt(pred_ppsqm_mean) * parseInt(form_map.get('calc_size')) / 1000).toFixed(0);
        pred_price_pc10 = 1000*(parseInt(pred_ppsqm_pc10) * parseInt(form_map.get('calc_size')) / 1000).toFixed(0);
        pred_price_pc90 = 1000*(parseInt(pred_ppsqm_pc90) * parseInt(form_map.get('calc_size')) / 1000).toFixed(0);

        price_string += ` <span style='font-size: 1.8em; color: dodgerblue'><b>£${pred_price_mean.toLocaleString()}</b></span>`
        if (form_map.get('calc_postcode').trim().length <= 4) 
          price_string += ` (~<b>£${pred_price_pc10.toLocaleString()}&ndash;${pred_price_pc90.toLocaleString()}</b>)`
        $('#calc_output').html(price_string);

        let nearest_postcodes = pns_short.concat(pns_long).filter(
          function(value) { 
            return value.postcode==form_map.get('calc_postcode').trim() 
          })[0];
        let comparison_string = "The same property <ul>"

        for (i = 1; i <= 3; i++) {
          var near_pc = nearest_postcodes[`nearest_pcs_${i}`];
          near_pc_pred_ppsqm_mean = pred_ppsqm + coefs.get(near_pc);
          near_pc_pred_ppsqm_pc10 = pred_ppsqm + coefs_pc10.get(near_pc);
          near_pc_pred_ppsqm_pc90 = pred_ppsqm + coefs_pc90.get(near_pc);
          near_pc_pred_price_mean = 1000*(parseInt(near_pc_pred_ppsqm_mean) * parseInt(form_map.get('calc_size')) / 1000).toFixed(0);
          near_pc_pred_price_pc10 = 1000*(parseInt(near_pc_pred_ppsqm_pc10) * parseInt(form_map.get('calc_size')) / 1000).toFixed(0);
          near_pc_pred_price_pc90 = 1000*(parseInt(near_pc_pred_ppsqm_pc90) * parseInt(form_map.get('calc_size')) / 1000).toFixed(0);

          comparison_string += `<li>in ${near_pc} would cost, on average, <b>£${near_pc_pred_price_mean.toLocaleString()}</b> (~£${near_pc_pred_price_pc10.toLocaleString()}&ndash;${near_pc_pred_price_pc90.toLocaleString()}) `
          if (near_pc_pred_price_mean > pred_price_mean + 1000) {
            comparison_string += "<span style='color: red; font-weight: bold; font-size: 1.2em'>&nearr;</span>"
          } else if (near_pc_pred_price_mean < pred_price_mean - 1000) {
            comparison_string += "<span style='color: green; font-weight: bold; font-size: 1.2em'>&searr;</span>"
          }
          comparison_string += '</li>'
        }
        comparison_string += '</ul>'

        $('#calc_output_2').html(comparison_string);

      } else {
        $('#calc_output').html('Postcode not valid');
      }

      return false;
    }

    // Legend changes
    function get_legend_label_from_colour_bands_array(o, index, arr) {
      var lab = '<i style="background: ' + o.html_colour + '"></i>'
      if (index == 0) {
        lab += 'Lowest 10%'
      } else if (arr.length == 7 && index == 3) {
        lab += 'Average'
      } else if (index == arr.length-1) {
        lab += 'Highest 10%'
      } 
      return lab;
    }
    map.on('baselayerchange', function(e) { 
      if (e.name == 'Postcodes - Flats') {
        var new_labels = colour_bands_flats.map(get_legend_label_from_colour_bands_array);
        $('.legend')[0].innerHTML = new_labels.join('<br>');
      } else if (e.name == 'Postcodes - Houses') {
        var new_labels = colour_bands_houses.map(get_legend_label_from_colour_bands_array);
        $('.legend')[0].innerHTML = new_labels.join('<br>');
      } else if (e.name == 'SOAs') {
        var new_labels = colour_bands_soas.map(get_legend_label_from_colour_bands_array);
        $('.legend')[0].innerHTML = new_labels.join('<br>');
      } else if (e.name == 'Postcodes - All') {
        var new_labels = colour_bands_glmmethod.map(get_legend_label_from_colour_bands_array);
        $('.legend')[0].innerHTML = new_labels.join('<br>');
      }
    });

    // Data table and read in other csvs
    $(document).ready(function() {

      $.ajax({
        url: 'static/ppsqm_nge10_simplemethod.csv',
        dataType: 'text',
        success: function(data) {
          let parsed_data = Papa.parse(data, {header: true, dynamicTyping: true}).data.slice(0,-1);

          $('#postcodes-all-table').DataTable( {
            responsive: true,
            data: parsed_data,
            columns: [
                { data: "Postcode", 
                  render: function(data) {return '<b>'+data+'</b>'},
                  responsivePriority: 1},
                { data: "SOA_LABEL", title: "SOA",
                  responsivePriority: 3},
                { data: "n", responsivePriority: 7, title: 'Number of properties'},
                { data: "mean_price_per_sq_m", 
                  title: "Mean price per m<sup>2</sup>",
                  render: DataTable.render.number(',', '.', 0, '£', null),
                  responsivePriority: 2 },
                { data: "mean_val",
                  title: "Mean actual price",
                  render: DataTable.render.number(',', '.', 0, '£', null),
                  responsivePriority: 4 },
                { data: "longitude", responsivePriority: 5, title: 'Longitude'},
                { data: "latitude", responsivePriority: 6, title: 'Latitude' },
            ],
            ordering: true
          } );
        }
      });

      Papa.parse('./static/postcodeshort_nearest_five.csv', {
        header: true,
        download: true,
        dynamicTyping: true,
        complete: function(results) {
          pns_short = results.data.slice(0,-1);
        }
      });
      
      Papa.parse('./static/postcodelongtoshort_nearest_five.csv', {
        header: true,
        download: true,
        dynamicTyping: true,
        complete: function(results) {
          pns_long = results.data.slice(0,-1);
        }
      });

      Papa.parse('./static/calculator_coefs.csv', {
        header: true,
        download: true,
        dynamicTyping: true,
        complete: function(results) {
          calculator_coefs = results.data.slice(0,-1);
        }
      });

      Papa.parse('./static/colour_bands_ppsqm_nge10_glmmethod.csv', {
        header: true, download: true, dynamicTyping: true,
        complete: function(results) {
          colour_bands_glmmethod = results.data.slice(0,-1);
          
          legend.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'info legend')
            var labels = colour_bands_glmmethod.map(get_legend_label_from_colour_bands_array);
            div.innerHTML = labels.join('<br>');
            return div;
          };
          legend.addTo(map);
        }
      });

      //load other colour band files
      Papa.parse('./static/colour_bands_ppsqm_nge10_glmmethod_houses.csv', {
        header: true, download: true, dynamicTyping: true,
        complete: function(results) {
          colour_bands_houses = results.data.slice(0,-1);
        }
      });
      Papa.parse('./static/colour_bands_ppsqm_nge10_glmmethod_flats.csv', {
        header: true, download: true, dynamicTyping: true,
        complete: function(results) {
          colour_bands_flats = results.data.slice(0,-1);
        }
      });
      //TODO change to glm method
      Papa.parse('./static/colour_bands_ppsqm_nge10_LSOAglmmethod.csv', {
        header: true, download: true, dynamicTyping: true,
        complete: function(results) {
          colour_bands_soas = results.data.slice(0,-1);
        }
      });

    });    

    //Postcode autocomplete
    $('#calc_postcode').autocomplete({
      source: function(term, suggest) {
        term = term.term.toLowerCase();
        var postcodes_short = pns_short.map(function(x) { return x.postcode; });
        var postcodes_long = pns_long.map(function(x) { return x.postcode; });
        var choices = postcodes_short.concat(postcodes_long);
        var matches = [];
        for (i=0; i<choices.length; i++)
          if (~choices[i].toLowerCase().indexOf(term)) matches.push(choices[i]);
        suggest(matches);
      },
      delay: 100,
      minLength: 3
    });

  </script>

</body>
